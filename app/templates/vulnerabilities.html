{% extends "base.html" %}
{% block title %}Vulnerability Assessment - InfraScanner Pro{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-0"><i class="fas fa-bug me-3"></i>Vulnerability Assessment</h1>
            <p class="text-muted mt-2">Comprehensive vulnerability analysis powered by Nuclei scanner</p>
        </div>
    </div>

    <!-- Enhanced Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-rocket me-2"></i>Start Vulnerability Scan</h5>
                </div>
                <div class="card-body">
                    {% if scanned_ips %}
                        <form action="{{ url_for('vulnerabilities') }}" method="post" id="vulnScanForm">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-6">
                                    <label class="form-label">Select Target IP Address</label>
                                    <select class="form-select" name="target_ip" id="target_ip" required>
                                        <option value="">Choose target IP address...</option>
                                        {% for ip in scanned_ips %}
                                        <option value="{{ ip }}">{{ ip }}</option>
                                        {% endfor %}
                                    </select>
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Found {{ scanned_ips|length }} target(s) with completed Nmap scans
                                    </small>
                                </div>
                                <div class="col-md-3">
                                    <div class="d-flex align-items-center">
                                        <div class="form-check form-switch me-3">
                                            <input class="form-check-input" type="checkbox" id="autoRefresh">
                                            <label class="form-check-label" for="autoRefresh">
                                                <small>Auto-refresh</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <button type="submit" class="btn btn-warning w-100" id="startScanBtn">
                                        <i class="fas fa-shield-alt me-2"></i>Start Vulnerability Scan
                                    </button>
                                </div>
                            </div>
                        </form>
                        
                        <div class="mt-3">
                            <button type="button" class="btn btn-outline-info" onclick="refreshTargets()">
                                <i class="fas fa-sync me-2"></i>Refresh Target List
                            </button>
                            <a href="{{ url_for('get_scans') }}" class="btn btn-outline-primary">
                                <i class="fas fa-search me-2"></i>View Nmap Scans
                            </a>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>No targets available!</strong> 
                            You need to run Nmap scans first before performing vulnerability assessments.
                        </div>
                        <div class="text-center">
                            <a href="{{ url_for('index') }}" class="btn btn-primary">
                                <i class="fas fa-play me-2"></i>Run Nmap Scan First
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="row mb-4">
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="stats-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="fw-bold text-primary mb-0">{{ scanned_ips|length }}</h3>
                        <p class="text-muted mb-0">Available Targets</p>
                    </div>
                    <i class="fas fa-bullseye text-primary" style="font-size: 2rem;"></i>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="stats-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="fw-bold text-warning mb-0">{{ vuln_by_target|length }}</h3>
                        <p class="text-muted mb-0">Targets Scanned</p>
                    </div>
                    <i class="fas fa-crosshairs text-warning" style="font-size: 2rem;"></i>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="stats-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="fw-bold text-danger mb-0">{{ total_vulns }}</h3>
                        <p class="text-muted mb-0">Total Vulnerabilities</p>
                    </div>
                    <i class="fas fa-bug text-danger" style="font-size: 2rem;"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug Information (only show if no targets) -->
    {% if not scanned_ips %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Troubleshooting Information</h6>
                </div>
                <div class="card-body">
                    <p><strong>To see targets here, ensure:</strong></p>
                    <ol>
                        <li>You have run at least one Nmap scan from the <a href="{{ url_for('index') }}">Home page</a></li>
                        <li>The scan completed successfully and saved data to MongoDB</li>
                        <li>Your MongoDB connection is working properly</li>
                        <li>The nmap_scans collection contains your scan results</li>
                    </ol>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="checkDatabase()">
                            <i class="fas fa-database me-2"></i>Check Database Connection
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Vulnerability Results (existing code continues...) -->
    {% if vuln_by_target %}
        {% for target, results in vuln_by_target.items() %}
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-server text-primary me-3" style="font-size: 1.5rem;"></i>
                        <div>
                            <h5 class="mb-0">{{ target }}</h5>
                            <small class="text-muted">{{ results|length }} scan(s) completed</small>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#vuln-{{ loop.index }}">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
            </div>
            
            <div class="collapse" id="vuln-{{ loop.index }}">
                <div class="card-body">
                    {% for result in results %}
                    <div class="border rounded p-4 mb-3 bg-light">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6><i class="fas fa-info-circle me-2"></i>Scan Information</h6>
                                <ul class="list-unstyled mb-0">
                                    <li><strong>Timestamp:</strong> {{ result.timestamp }}</li>
                                    <li><strong>Total Vulnerabilities:</strong> 
                                        <span class="badge {{ 'bg-danger' if result.total_vulns > 10 else 'bg-warning' if result.total_vulns > 5 else 'bg-success' }}">
                                            {{ result.total_vulns }}
                                        </span>
                                    </li>
                                    {% if result.summary and result.summary.risk_score %}
                                    <li><strong>Risk Score:</strong> 
                                        <span class="badge {{ 'bg-danger' if result.summary.risk_score > 80 else 'bg-warning' if result.summary.risk_score > 60 else 'bg-info' if result.summary.risk_score > 30 else 'bg-success' }}">
                                            {{ result.summary.risk_score }}/100
                                        </span>
                                    </li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                        
                        {% if result.vulnerabilities and result.vulnerabilities|length > 0 %}
                        <h6><i class="fas fa-list me-2"></i>Vulnerability Details</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Severity</th>
                                        <th>Name</th>
                                        <th>Template</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for vuln in result.vulnerabilities[:10] %}
                                    <tr>
                                        <td>
                                            {% set severity = vuln.get('info', {}).get('severity', vuln.get('severity', 'info')) %}
                                            <span class="badge {{ 'bg-danger' if severity == 'critical' else 'bg-warning' if severity == 'high' else 'bg-info' if severity == 'medium' else 'bg-success' if severity == 'low' else 'bg-secondary' }}">
                                                {{ severity.title() }}
                                            </span>
                                        </td>
                                        <td>{{ vuln.get('info', {}).get('name', vuln.get('template_id', 'Unknown')) }}</td>
                                        <td><code>{{ vuln.get('template', vuln.get('template_id', 'Unknown')) }}</code></td>
                                        <td>{{ vuln.get('info', {}).get('description', vuln.get('details', 'No details available'))[:100] }}...</td>
                                    </tr>
                                    {% endfor %}
                                    {% if result.vulnerabilities|length > 10 %}
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">
                                            <i class="fas fa-ellipsis-h me-2"></i>and {{ result.vulnerabilities|length - 10 }} more vulnerabilities
                                        </td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-check-circle text-success" style="font-size: 2rem;"></i>
                            <p class="text-muted mt-2 mb-0">No vulnerabilities found for this scan</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    {% endif %}
</div>

<script>
// Refresh target list
function refreshTargets() {
    location.reload();
}

// Check database connection
function checkDatabase() {
    fetch('/api/time')
        .then(response => response.json())
        .then(data => {
            alert('Database connection is working. Current server time: ' + data.time);
        })
        .catch(error => {
            alert('Database connection failed: ' + error.message);
        });
}

// Auto-refresh functionality
let autoRefreshInterval;
document.getElementById('autoRefresh').addEventListener('change', function() {
    if (this.checked) {
        autoRefreshInterval = setInterval(refreshTargets, 30000); // Refresh every 30 seconds
    } else {
        clearInterval(autoRefreshInterval);
    }
});

// Form validation
document.getElementById('vulnScanForm').addEventListener('submit', function(e) {
    const targetIp = document.getElementById('target_ip').value;
    if (!targetIp) {
        e.preventDefault();
        alert('Please select a target IP address');
        return false;
    }
    
    // Disable button to prevent double submission
    document.getElementById('startScanBtn').disabled = true;
    document.getElementById('startScanBtn').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Starting Scan...';
});
</script>
{% endblock %}
